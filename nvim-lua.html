<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Migrating to Neovim Lua config &#8212; dotfiles  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=c058f7c8" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Why?" href="why.html" />
    <link rel="prev" title="Post-setup tasks" href="post.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="post.html" title="Previous document">Post-setup tasks</a>
        </li>
        <li>
          <a href="why.html" title="Next document">Why?</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <section id="migrating-to-neovim-lua-config">
<span id="nvim-lua"></span><h1>Migrating to Neovim Lua config<a class="headerlink" href="#migrating-to-neovim-lua-config" title="Link to this heading">¶</a></h1>
<p>Neovim has been supporting a lot of interesting new features. Historically,
in these dotfiles I’ve tried to largely maintain backward compatibility with vim
by keeping <code class="file docutils literal notranslate"><span class="pre">.config/nvim/init.vim</span></code> symlinked to <code class="file docutils literal notranslate"><span class="pre">.vimrc</span></code>. But I realized
that this was preventing me from using a lot of the new functionality.</p>
<p>One of the nice features of nvim is being able to configure with Lua. I’ve never
been able to get the hang of VimL (the internal vim language), but was able to
quickly pick up Lua since it has a lot of similarities with Python. It is very
empowering to have the full use of a language like Lua to use in configuration!</p>
<p>I finally decided to take the plunge and convert my vim+neovim config into
a full-fledged Lua nvim config. This forces a dichotomy between vim and nvim,
but realistically I only ever use nvim. Now there’s only a barebones <code class="docutils literal notranslate"><span class="pre">.vimrc</span></code>
for the rare occasions when I need to use <code class="file docutils literal notranslate"><span class="pre">/usr/bin/vim</span></code> for some reason.</p>
<p>This page is for those of you who have used these dotfiles before, and might
even have modified your own vim+nvim config…but now with with this newfangled
config you don’t know what’s going on!</p>
<p><strong>TL;DR: to try out the new version</strong></p>
<p>First, back up your existing config.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Back up old files</span>
mv<span class="w"> </span>~/.config/nvim<span class="w"> </span>~/.config/nvim-backup
mv<span class="w"> </span>~/.vimrc<span class="w"> </span>~/.vimrc-backup
mv<span class="w"> </span>~/.vim<span class="w"> </span>~/.vim-backup
</pre></div>
</div>
<p>Then manually copy the relevant files from this repo (that is, don’t use the
<code class="docutils literal notranslate"><span class="pre">--dotfiles</span></code> argument to <code class="file docutils literal notranslate"><span class="pre">setup.sh</span></code> since that will copy over more than
just these):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># here we refer to the dotfiles repo dir;</span>
<span class="c1"># modify accordingly for where you put it.</span>
cp<span class="w"> </span>-r<span class="w"> </span>dotfiles/.config/nvim<span class="w"> </span>~/.config/nvim
cp<span class="w"> </span>dotfiles/.vimrc<span class="w"> </span>~/.vimrc
</pre></div>
</div>
<p>Then open up nvim, and wait for the installations to complete. You should be
good to go.</p>
<p>Here are some initial things to try:</p>
<ul>
<li><p><kbd class="kbd docutils literal notranslate">&lt;leader&gt;</kbd> (by default, <kbd class="kbd docutils literal notranslate">,</kbd>) and then wait a second. You’ll get
a menu that pops up, showing you the currently-configured key mappings that
follow &lt;leader&gt;. Hitting a listed key will execute the command. Sometimes
you’ll see <code class="docutils literal notranslate"><span class="pre">-&gt;</span> <span class="pre">+prefix</span></code> in the menu, which means you can hit that key to see
a menu of the things you can type after that. If you go too far, use
<kbd class="kbd docutils literal notranslate">&lt;Backspace&gt;</kbd> to go back a step.</p>
<p>In fact, you can hit backspace a few times to get to the base vim commands. It
can be helpful to look through to see if there’s any you’ve forgotten about!</p>
</li>
<li><p>which-key also pops up if you use <kbd class="kbd docutils literal notranslate">'</kbd> (for marks), and helps you navigate
between them.</p></li>
<li><p><kbd class="kbd docutils literal notranslate">z=</kbd> over a word to get a pop-up for spelling suggestions</p></li>
<li><p>Saner tab completion (hit tab until you like what you see). Snippets are
enabled, so if you’re in a Python file for example, type <code class="docutils literal notranslate"><span class="pre">def</span></code> and then hit
<kbd class="kbd docutils literal notranslate">&lt;Tab&gt;</kbd>. One of the options will be a snippet to create a Python
function. There are also other “flavors” of snippets, for example whether you
want to return from the function, o if you’re writing method. Use
<kbd class="kbd docutils literal notranslate">&lt;Tab&gt;</kbd> to jump between the placeholders, and immediately start typing
to replace them.</p></li>
<li><p><kbd class="kbd docutils literal notranslate">KJ</kbd> (so, hold down shift and type <code class="docutils literal notranslate"><span class="pre">kj</span></code>) to flash a beacon
where the cursor is. This also works when jumping between search hits.</p></li>
<li><p><kbd class="kbd docutils literal notranslate">&lt;leader&gt;ff</kbd> to open a file selector within this directory</p></li>
<li><p><kbd class="kbd docutils literal notranslate">&lt;leader&gt;fg</kbd> to live-grep within the directory (hit enter on the search
result to open the file at that location). Great for exploring new codebases.</p></li>
<li><p>Open a file in a git repo with some changes. Then use <kbd class="kbd docutils literal notranslate">]c</kbd> to go to the
next change (hunk) and <kbd class="kbd docutils literal notranslate">&lt;leader&gt;hp</kbd> to preview hunks.</p></li>
<li><p>Open a file browser with <kbd class="kbd docutils literal notranslate">&lt;leader&gt;fbo</kbd>, hit Enter to select, or <kbd class="kbd docutils literal notranslate">-</kbd>
to go up a level</p></li>
<li><p>Open a Python file with lots of classes/functions, or a markdown or RMarkdown
file. Use <kbd class="kbd docutils literal notranslate">&lt;leader&gt;a</kbd> to open a panel for navigation within the file.</p></li>
</ul>
<p>Don’t like it? Do this to revert:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># aaaaah! revert! revert!</span>
<span class="n">mv</span> <span class="o">~/.</span><span class="n">config</span><span class="o">/</span><span class="n">nvim</span> <span class="o">~/.</span><span class="n">config</span><span class="o">/</span><span class="n">nvim</span><span class="o">-</span><span class="n">lua</span>
<span class="n">mv</span> <span class="o">~/.</span><span class="n">config</span><span class="o">/</span><span class="n">nvim</span><span class="o">-</span><span class="n">backup</span> <span class="o">~/.</span><span class="n">config</span><span class="o">/</span><span class="n">nvim</span>
<span class="n">rm</span> <span class="o">~/.</span><span class="n">vimrc</span>
<span class="n">mv</span> <span class="o">~/.</span><span class="n">vimrc</span><span class="o">-</span><span class="n">backup</span> <span class="o">~/.</span><span class="n">vimrc</span>
<span class="n">mv</span> <span class="o">~/.</span><span class="n">vim</span><span class="o">-</span><span class="n">backup</span> <span class="o">~/.</span><span class="n">vim</span>
</pre></div>
</div>
<p>The rest of this page gives some more context so you can make your own changes.</p>
<section id="structure">
<h2>Structure<a class="headerlink" href="#structure" title="Link to this heading">¶</a></h2>
<p>First, there’s no more <code class="docutils literal notranslate"><span class="pre">init.vim</span></code>. It’s <code class="docutils literal notranslate"><span class="pre">init.lua</span></code> instead.</p>
<p>There is an additional <code class="file docutils literal notranslate"><span class="pre">lua/plugins/init.lua</span></code> which holds plugin configuration.</p>
<p>I had initially completely modularized things into separate settings,
autocommands, mappings, colorscheme, and plugins files. But after living with
that a bit, I decided to go back to a single main config with settings,
mappings, autocommands, and colorscheme, and only having a separate plugins
file.</p>
</section>
<section id="lua">
<h2>Lua<a class="headerlink" href="#lua" title="Link to this heading">¶</a></h2>
<p>More info on Lua:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://neovim.io/doc/user/lua-guide.html">nvim Lua guide</a></p></li>
<li><p><a class="reference external" href="https://neovim.io/doc/user/luaref.html">nvim Lua reference</a></p></li>
<li><p><a class="reference external" href="https://neovim.io/doc/user/lua.html#lua-concepts">nvim Lua concept and idioms</a></p></li>
</ul>
<p>But for a quick intro, here are some of my notes:</p>
<ul>
<li><p>Any vim commands can be trivially converted to Lua by wrapping them in
<code class="docutils literal notranslate"><span class="pre">vim.cmd()</span></code>. See the <a class="reference external" href="https://neovim.io/doc/user/lua-guide.html#lua-guide-vim-commands">nvim docs on running Vim commands with Lua</a> for more
info.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--</span></code> indicates comments</p></li>
<li><p>Lua makes extensive use of <em>tables</em>. A table is delimited by <code class="docutils literal notranslate"><span class="pre">{}</span></code>. It’s an
associative array, sort of like like a Python dict, or an R named list, or
a Perl hash.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">-- a table</span>
<span class="p">{</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="s2">&quot;asdf&quot;</span> <span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Functions are defined with a <code class="docutils literal notranslate"><span class="pre">function</span> <span class="pre">...</span> <span class="pre">end</span></code> block. Functions can be
called multiple different ways. Functions can be anonymous (omit the “myfunc”
identifier below).</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">myfunc</span> <span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">arg1</span> <span class="o">+</span> <span class="n">arg2</span>
<span class="kr">end</span>
</pre></div>
</div>
</li>
<li><p>Functions can be called in different ways. Parentheses are optional if the
function has a single argument. Here are some examples from the <a class="reference external" href="https://www.lua.org/pil/5.html">Lua docs on
functions</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="s2">&quot;Hello World&quot;</span>     <span class="o">&lt;--&gt;</span>     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">)</span>
<span class="n">dofile</span> <span class="s1">&#39;a.lua&#39;</span>          <span class="o">&lt;--&gt;</span>     <span class="n">dofile</span> <span class="p">(</span><span class="s1">&#39;a.lua&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">[[</span><span class="n">a</span> <span class="n">multi</span><span class="o">-</span><span class="n">line</span>    <span class="o">&lt;--&gt;</span>     <span class="nb">print</span><span class="p">([[</span><span class="n">a</span> <span class="n">multi</span><span class="o">-</span><span class="n">line</span>
 <span class="n">message</span><span class="p">]]</span>                        <span class="n">message</span><span class="p">]])</span>
<span class="n">f</span><span class="p">{</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">20</span><span class="p">}</span>           <span class="o">&lt;--&gt;</span>     <span class="n">f</span><span class="p">({</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">20</span><span class="p">})</span>
<span class="nb">type</span><span class="p">{}</span>                  <span class="o">&lt;--&gt;</span>     <span class="nb">type</span><span class="p">({})</span>
</pre></div>
</div>
</li>
<li><p>Import other Lua code with the <code class="docutils literal notranslate"><span class="pre">require</span></code> function. If <code class="docutils literal notranslate"><span class="pre">init.lua</span></code> is in
a directory, requiring that directory will automatically use the <code class="docutils literal notranslate"><span class="pre">init.lua</span></code>
(it’s like Python’s <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>). See the <a class="reference external" href="https://neovim.io/doc/user/lua-guide.html#lua-guide-modules">nvim docs on lua modules</a> for more.</p></li>
</ul>
</section>
<section id="lazy-vim-for-plugins">
<h2>lazy.vim for plugins<a class="headerlink" href="#lazy-vim-for-plugins" title="Link to this heading">¶</a></h2>
<p>This config uses <a class="reference external" href="https://github.com/folke/lazy.nvim">lazy.nvim</a> for managing
plugins. I like the design of how it encourages modular plugin configs. This
also encourages and supports keeping the plugin-specific keymappings with the
plugin itself. The interface is also quite nice (though you need a <a class="reference external" href="https://www.nerdfonts.com/font-downloads">patched Nerd
Font</a> for your font of interest, and
this font should be configured to be used by the terminal program you’re using).</p>
<p>The lazy-loading aspect of it is a bonus. When configured, a plugin will not
load until it’s triggered – via a dependency requirement from another plugin,
by using a command, or by using a keymapping. This offers very quick startup
speed while still supporting lots of plugins.</p>
<p>See <code class="docutils literal notranslate"><span class="pre">:Lazy</span></code> for the interface, where you can see timings for how long it took
things to load as well as the ability to update or clean up plugins. This is
similar to <code class="docutils literal notranslate"><span class="pre">:PlugInstall</span></code> and <code class="docutils literal notranslate"><span class="pre">:PlugClean</span></code> from the previous versions of
these dotfiles.</p>
</section>
<section id="creating-keymappings">
<h2>Creating keymappings<a class="headerlink" href="#creating-keymappings" title="Link to this heading">¶</a></h2>
<p>For Lua, see the <a class="reference external" href="https://neovim.io/doc/user/lua-guide.html#lua-guide-mappings">nvim docs on creating mappings with Lua</a> for more
details. This is for mappings created within <code class="file docutils literal notranslate"><span class="pre">init.lua</span></code>, for example.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">-- directly in Lua</span>
<span class="n">vim</span><span class="p">.</span><span class="n">keymap</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;leader&gt;1&quot;</span><span class="p">,</span> <span class="s2">&quot;:bfirst&lt;CR&gt;&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;First buffer&quot;</span> <span class="p">})</span>
</pre></div>
</div>
<p>For plugins managed by lazy.nvim, they are instead specified in the <code class="docutils literal notranslate"><span class="pre">keys</span></code>
property of the plugin’s table:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in a plugin</span>
<span class="p">{</span>
  <span class="s2">&quot;plugin/name&quot;</span><span class="p">,</span>
  <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="s2">&quot;&lt;leader&gt;1&quot;</span><span class="p">,</span> <span class="s2">&quot;:bfirst&lt;CR&gt;&quot;</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;First buffer&quot;</span> <span class="p">},</span>
  <span class="p">},</span>
  <span class="c1">-- possibly other stuff for plugin...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In both cases, note the use of <code class="docutils literal notranslate"><span class="pre">desc</span></code>. This description is picked up by the
which-key plugin to populate the menu. When setting in Lua directly, <code class="docutils literal notranslate"><span class="pre">desc</span></code>
needs to be in a table. When setting in a plugin config, it’s not in a table.</p>
</section>
<section id="how-to-add-configure-plugins">
<span id="how-plugins-work"></span><h2>How to add/configure plugins<a class="headerlink" href="#how-to-add-configure-plugins" title="Link to this heading">¶</a></h2>
<p>Edit <code class="file docutils literal notranslate"><span class="pre">lua/plugins.lua</span></code>.</p>
<p>Follow the existing plugin files for a guide, but basically you’re aiming for
something like this:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">return</span> <span class="p">{</span>
  <span class="s2">&quot;username/reponame&quot;</span><span class="p">,</span>
  <span class="n">config</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
    <span class="c1">-- stuff here for setup. Might include keybindings or more complicated</span>
    <span class="c1">-- things.</span>
  <span class="kr">end</span><span class="p">,</span>
  <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">-- ... see above for discussion of keys</span>
  <span class="p">},</span>
  <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">--</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="post.html" title="Previous document">Post-setup tasks</a>
        </li>
        <li>
          <a href="why.html" title="Next document">Why?</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">dotfiles</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="starthere.html">Start here</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Additional tool installations</a></li>
<li class="toctree-l1"><a class="reference internal" href="bash.html">Bash dotfiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="vim.html">Vim (neovim) configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="tmux.html">tmux configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="conda.html">conda</a></li>
<li class="toctree-l1"><a class="reference internal" href="post.html">Post-setup tasks</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Migrating to Neovim Lua config</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#structure">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lua">Lua</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lazy-vim-for-plugins">lazy.vim for plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-keymappings">Creating keymappings</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-add-configure-plugins">How to add/configure plugins</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="why.html">Why?</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="post.html" title="previous chapter">Post-setup tasks</a></li>
      <li>Next: <a href="why.html" title="next chapter">Why?</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div><script>
    let closest;
    // Get the last part of the URL after the # symbol - should match the div id to display
    let id = window.location.hash.substring(1);
    let elem = document.getElementById(id);
    if (elem != null) {
        // Get the closest "details" element and open it
        closest = elem.closest("details");
        closest.open = true;
    }
</script>
  </body>
</html>